<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Electricity Bill Splitter</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 10px;
      font-size: 14px;
    }

    .compact-form .form-control {
      padding: .4rem .5rem;
      font-size: .95rem;
    }

    .table-sm th,
    .table-sm td {
      padding: .4rem;
      font-size: .95rem;
    }

    .bill-bold {
      font-weight: 700;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Slab Charges -->
    <h6 class="mb-2">Slab Charges</h6>
    <div class="row g-1 mb-2">
      <div class="col-4">
        <label class="form-label">0-100</label>
        <input type="number" id="slab1" class="form-control" value="4.23" step="0.01">
      </div>
      <div class="col-5">
        <label class="form-label">101-300</label>
        <input type="number" id="slab2" class="form-control" value="11" step="0.01">
      </div>
      <div class="col-3">
        <label class="form-label">301-500</label>
        <input type="number" id="slab3" class="form-control" value="15.28" step="0.01">
      </div>
    </div>

    <!-- Extra Charges -->
    <h6 class="mb-2">Extra Charges</h6>
    <div class="row g-1 mb-2">
      <div class="col-3">
        <label class="form-label">Fixed Charges</label>
        <input type="number" id="fixedCharges" class="form-control" value="140" step="0.01">
      </div>
      <div class="col-4">
        <label class="form-label">Wheeling Charges (₹/unit)</label>
        <input type="number" id="wheelingChargesPerUnit" class="form-control" value="1.47" step="0.01">
      </div>
      <div class="col-3">
        <label class="form-label">Electricity Duty (%)</label>
        <input type="number" id="electricityDutyInPercent" class="form-control" value="16" step="0.01">
      </div>
      <div class="col-2">
        <label class="form-label">Minus Amount</label>
        <input type="number" id="minusAmount" class="form-control" value="140" step="0.01">
      </div>
    </div>

    <!-- Last Month Reading -->
    <form id="lastBillUnitForm" class="compact-form mb-3">
      <h6 class="mb-2">Last Month Reading</h6>
      <div class="row g-2">
        <div class="col-3">
          <label class="form-label">1RK</label>
          <input type="number" class="form-control" id="last1" placeholder="1RK">
        </div>
        <div class="col-3"><label class="form-label">1BHK</label>
          <input type="number" class="form-control" id="last2" placeholder="1BHK">
        </div>
        <div class="col-3">
          <label class="form-label">Common</label>
          <input type="number" class="form-control" id="last3" placeholder="Common">
        </div>
        <div class="col-3">
          <label class="form-label">1st Floor</label>
          <input type="number" class="form-control" id="last4" placeholder="1st Floor">
        </div>
      </div>
    </form>

    <!-- Current Month Reading -->
    <form id="billForm" class="compact-form">
      <h6 class="mb-2">Current Month Reading</h6>
      <div class="row g-2">
        <div class="col-3">
          <label class="form-label">1RK</label>
          <input type="number" class="form-control" id="curr1" placeholder="1RK">
        </div>
        <div class="col-3">
          <label class="form-label">1BHK</label>
          <input type="number" class="form-control" id="curr2" placeholder="1BHK">
        </div>
        <div class="col-3">
          <label class="form-label">Common</label>
          <input type="number" class="form-control" id="curr3" placeholder="Common">
        </div>
        <div class="col-3">
          <label class="form-label">1st Floor</label>
          <input type="number" class="form-control" id="curr4" placeholder="1st Floor">
        </div>
      </div>
      <div class="mt-3">
        <button type="submit" class="btn btn-primary w-100 btn-sm">Calculate Bill</button>
      </div>
    </form>

    <div id="note" class="small text-danger mt-2"></div>
    <div id="result" class="mt-3"></div>
  </div>

  <script>
    // Labels used for display
    const PAYER_LABELS = ["1RK", "1BHK", "1st Floor"];
    // Other Charges
    let otherCharges = {}
    // Robust equal-per-slab allocator (never produces negative allocations)
    function splitBillEqualAllocation(units, slabs, fixedChargesShare, minusAmountShare) {
      const unitsLength = units.length;
      let remaining = units.slice();                 // remaining units per meter
      let perMeterCost = Array(unitsLength).fill(0);
      let totalBill = 0;
      const breakdown = [];
      let prevLimit = 0;

      for (const slab of slabs) {
        const totalRem = remaining.reduce((a, b) => a + b, 0);
        if (totalRem <= 0) break;

        const capacity = Math.min(slab.limit - prevLimit, totalRem);
        if (capacity <= 0) { prevLimit = slab.limit; continue; }

        const allocatedUnitsFromSlab = Array(unitsLength).fill(0);
        const costs = Array(unitsLength).fill(0);

        // active meters are those with >0 remaining
        let active = [];
        for (let i = 0; i < unitsLength; i++) if (remaining[i] > 1e-9) active.push(i);

        let left = capacity;
        while (left > 1e-9 && active.length > 0) {
          const share = left / active.length;
          for (let i = active.length - 1; i >= 0; i--) {
            const idx = active[i];
            const take = Math.min(remaining[idx], share);
            allocatedUnitsFromSlab[idx] += take;
            remaining[idx] -= take;
            left -= take;
            if (remaining[idx] <= 1e-9) active.splice(i, 1);
          }
        }
        // console.log("allocatedUnitsFromSlab:" + allocatedUnitsFromSlab);

        for (let i = 0; i < unitsLength; i++) {
          costs[i] = Math.round(allocatedUnitsFromSlab[i] * slab.rate);
          perMeterCost[i] += costs[i];
          // totalBill += costs[i];
        }

        //
        breakdown.push({
          slab: `${prevLimit + 1}–${slab.limit}`,
          rate: slab.rate,
          units: allocatedUnitsFromSlab.map(v => +v.toFixed(0)),
          cost: costs.map(v => +v.toFixed(0))
        });

        prevLimit = slab.limit;
      }
      console.log("perMeterCost:" + JSON.stringify(perMeterCost));

      // Add WC- wheeling charges for each meter
      const perMeterCostWithWC = perMeterCost.map((item, index) => {
        const total = item + (units[index] * otherCharges.wheelingChargesPerUnit);
        return Math.round(total);
      });
      console.log("perMeterCostWithWC:" + perMeterCostWithWC);

      // Add ED - add electricity duty for each meter, add FCH - fixed charges share
      const perMeterCostWithEDFCH = perMeterCostWithWC.map(item => {
        const electricityDutyInPercent = item * (otherCharges.electricityDutyInPercent / 100);
        console.log("electricityDutyInPercent:", electricityDutyInPercent);
        return Math.round(item + electricityDutyInPercent + fixedChargesShare) - minusAmountShare;
      });
      console.log("perMeterCostWithEDFCH:" + perMeterCostWithEDFCH);

      // Round rupees per meter; adjust last to keep exact total      
      totalBill = perMeterCostWithEDFCH.reduce((a, b) => a + b, 0);      
      console.log("totalBill:", totalBill);

      return { perMeterCostWithWC, finalPerMeterCost: perMeterCostWithEDFCH, totalBill, breakdown };
    }

    document.getElementById("billForm").addEventListener("submit", function (e) {
      e.preventDefault();

      // Slabs: 0–100 @ ₹5; 101–300 @ ₹11; 301–500 @ ₹15
      const SLABS = [
        { limit: 100, rate: +document.getElementById("slab1").value },
        { limit: 300, rate: +document.getElementById("slab2").value },
        { limit: 500, rate: +document.getElementById("slab3").value }
      ];

      // Other Charges
      otherCharges = {
        fixedCharges: +document.getElementById("fixedCharges").value,
        wheelingChargesPerUnit: +document.getElementById("wheelingChargesPerUnit").value, // its per Unit
        electricityDutyInPercent: +document.getElementById("electricityDutyInPercent").value // in percentage
      }

      // Read last & current
      const last = [
        +document.getElementById("last1").value || 0,
        +document.getElementById("last2").value || 0,
        +document.getElementById("last3").value || 0,
        +document.getElementById("last4").value || 0
      ];
      const current = [
        +document.getElementById("curr1").value || 0,
        +document.getElementById("curr2").value || 0,
        +document.getElementById("curr3").value || 0,
        +document.getElementById("curr4").value || 0
      ];

      // mock data for dev debugging
      // const SLABS = [
      //   { limit: 100, rate: 4.23 },
      //   { limit: 300, rate: 11 },
      //   { limit: 500, rate: 15.28 }
      // ];      

      // const last = [
      //   521,
      //   323,
      //   802,
      //   0
      // ];
      // const current = [
      //   605,
      //   373,
      //   890,
      //   131
      // ];

      // otherCharges = {
      //   fixedCharges: 140,
      //   wheelingChargesPerUnit: 1.47, // its per Unit
      //   electricityDutyInPercent: 16 // in percentage
      // }
      console.log("SLABS:", SLABS);
      console.log("otherCharges:", otherCharges);

      // 
      const minusAmount = +document.getElementById("minusAmount").value || 0;

      // Monthly consumption = max(0, current - last), avoids negatives
      let hadNeg = false;
      const unitsConsumed = current.map((c, i) => {
        const d = c - last[i];
        if (d < 0) hadNeg = true;
        return Math.max(0, d);
      });
      console.log("unitsConsumed:", unitsConsumed);

      // fixed charges split into the three paying meters (as units, before slab billing)
      const fixedChargesShare = Math.round(otherCharges.fixedCharges / 3);
      console.log("fixedChargesShare:", fixedChargesShare);

      // Minus amount that will split into the three paying meters (as units, before slab billing)
      const minusAmountShare = Math.round(minusAmount / 3);
      console.log("minusAmountShare:", minusAmountShare);

      // Common split into the three paying meters (as units, before slab billing)
      const commonShare = Math.round(unitsConsumed[2] / 3);
      const payUnits = [
        unitsConsumed[0] + commonShare,  // 1RK
        unitsConsumed[1] + commonShare,  // 1BHK
        unitsConsumed[3] + commonShare   // 1st Floor
      ];

      // Total consumed units
      const totalUnits = payUnits.reduce((a, b) => a + b, 0).toFixed(0);
      console.log("totalUnits:", totalUnits);

      // Compute bill
      const bill = splitBillEqualAllocation(payUnits, SLABS, fixedChargesShare, minusAmountShare);
      console.log("bill:", bill);

      // Top note if any negative delta was clamped
      document.getElementById("note").textContent = hadNeg
        ? "Note: Some readings decreased vs last month; negative differences were treated as 0."
        : "";

      // Build Summary table (shows original, +common, final units, and bold bill)
      const orig = [unitsConsumed[0], unitsConsumed[1], unitsConsumed[3]];
      const labels = PAYER_LABELS;
      let html = `
    <h6 class="mb-2">Bill Summary</h6>
    <table class="table table-bordered table-sm text-center align-middle">
      <thead class="table-light">
        <tr>
          <th>Meter</th>
          <th>Units</th>
          <th>+ Common</th>
          <th>Total Units</th>                    
          <th>+ Wheeling Charges/Unit (₹${otherCharges.wheelingChargesPerUnit}/Unit)</th>          
          <th>Bill (₹)</th>
          <th>+ Electricity Duty in % (${otherCharges.electricityDutyInPercent}%) on Bill</th>
          <th>+ Fixed Charges (₹${otherCharges.fixedCharges})</th>
          <th class="bill-bold">Final Bill (₹)</th>
        </tr>
      </thead>
      <tbody>
        ${labels.map((lab, i) => `
          <tr>
            <td class="bill-bold">${lab}</td>
            <td>${orig[i]}</td>
            <td>${commonShare}</td>
            <td class="bill-bold">${payUnits[i]}</td>            
            <td>${Math.round(payUnits[i] * otherCharges.wheelingChargesPerUnit)}</td>            
            <td>₹${bill.perMeterCostWithWC[i]}</td>
            <td>₹${Math.round(bill.perMeterCostWithWC[i] * (otherCharges.electricityDutyInPercent / 100))}</td>
            <td>${fixedChargesShare.toFixed(0)}</td>
            <td class="bill-bold">${bill.finalPerMeterCost[i]}</td>
          </tr>
        `).join('')}
        <tr class="table-secondary">
          <td colspan="3"><strong>Total</strong></td>
          <td><strong>${totalUnits}</strong></td>
          <td colspan="4"></td>
          <td class="bill-bold"><strong>₹${bill.totalBill}</strong></td>
        </tr>
      </tbody>
    </table>
  `;

      // Slab-wise breakdown for paying meters
      html += `
    <h6 class="mb-2">Slab-wise Breakdown</h6>
    <table class="table table-bordered table-sm text-center align-middle">
      <thead class="table-light">
        <tr>
          <th>Slab</th>
          <th>Rate (₹/u)</th>
          ${labels.map(l => `<th>${l} (U)</th>`).join("")}
          ${labels.map(l => `<th>${l} (₹)</th>`).join("")}
        </tr>
      </thead>
      <tbody>
        ${bill.breakdown.map(r => `
          <tr>
            <td>${r.slab}</td>
            <td>${r.rate}</td>
            ${r.units.map(u => `<td>${u}</td>`).join("")}
            ${r.cost.map(c => `<td>${c}</td>`).join("")}
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;

      document.getElementById("result").innerHTML = html;
    });
  </script>
</body>

</html>